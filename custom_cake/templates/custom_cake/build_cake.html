{% extends 'base.html' %}
{% load static %}
{% get_static_prefix as STATIC_PREFIX %}

{% block content %}
<style>
:root {
    --main-brown: #5a4a3d;
    --light-beige: #f5f0e6;
    --border-radius: 12px;
    --input-bg: #faf7f2;
    --input-border: #d9d4ca;
    --input-focus-border: #bfa67a;
    --text-color: #3e2f22;
    --placeholder-color: #a89f94;
    --checkbox-color: #5a4a3d;
    --button-bg: #5a4a3d;
    --button-hover-bg: #3e2f22;
    --error-color: #c94e4e;
    --section-bg: #fff9f0;
    --highlight: #ffd700;
}

.custom-cake-container {
    max-width: 900px;
    margin: 40px auto 60px;
    background: var(--light-beige);
    border-radius: var(--border-radius);
    box-shadow: 0 6px 18px rgba(90, 74, 61, 0.15);
    padding: 40px 35px;
    color: var(--text-color);
}

.custom-cake-title {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--main-brown);
    margin-bottom: 30px;
    text-align: center;
    letter-spacing: 1px;
}

.cake-builder {
    display: flex;
    gap: 30px;
    margin-bottom: 40px;
}

.cake-visual {
    flex: 1;
    min-width: 300px;
    background: var(--section-bg);
    border-radius: var(--border-radius);
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
    position: relative;
    overflow: hidden;
}

.cake-preview-container {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.cake-decoration-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    margin-top: 20px;
    width: 100%;
}

.cake-decoration-item {
    width: 80px;
    height: 80px;
    background: white;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    border: 2px solid var(--input-border);
}

.cake-decoration-item img {
    max-width: 60px;
    max-height: 60px;
}

.cake-preview {
    width: 250px;
    height: 250px;
    position: relative;
    display: flex;
    flex-direction: column;
    margin: 20px 0;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border-radius: 8px;
    overflow: hidden;
}

.cake-outside {
    position: absolute;
    width: 100%;
    height: 100%;
    background: #f5f0e6;
    z-index: 1;
    border: 2px solid var(--main-brown);
}

.cake-inside {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    z-index: 2;
    overflow: hidden;
}

.cake-biscuit-top {
    height: 60px;
    background: #e8c988;
    border-bottom: 2px solid rgba(0,0,0,0.1);
}

.cake-biscuit-bottom {
    height: 60px;
    background: #e8c988;
    border-top: 2px solid rgba(0,0,0,0.1);
}

.cake-cream {
    flex-grow: 1;
    background: #f5e6c8;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}

.cake-filling {
    width: 80%;
    height: 40px;
    background: #e6b574;
    border-radius: 20px;
}

.cake-options {
    flex: 1;
    min-width: 300px;
}

.option-tabs {
    display: flex;
    margin-bottom: 20px;
    border-bottom: 2px solid var(--input-border);
}

.option-tab {
    padding: 10px 20px;
    cursor: pointer;
    font-weight: 600;
    color: var(--text-color);
    border-bottom: 3px solid transparent;
    transition: all 0.2s;
}

.option-tab.active {
    color: var(--main-brown);
    border-bottom: 3px solid var(--main-brown);
}

.option-content {
    display: none;
}

.option-content.active {
    display: block;
}

.option-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 15px;
}

.option-item {
    background: var(--section-bg);
    border-radius: 8px;
    padding: 15px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid transparent;
}

.option-item:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.option-item.selected {
    border-color: var(--main-brown);
    background: #f0e6d2;
}

.option-item img {
    width: 50px;
    height: 50px;
    object-fit: contain;
    margin-bottom: 10px;
}

.option-item .option-name {
    font-weight: 600;
    font-size: 0.9rem;
}

.custom-input {
    margin-top: 15px;
    display: none;
}

.price-block {
    font-size: 1.5rem;
    font-weight: 700;
    text-align: center;
    margin: 30px 0 40px;
    color: var(--main-brown);
    letter-spacing: 0.5px;
}

.submit-btn {
    display: block;
    width: 100%;
    padding: 14px 0;
    background: var(--button-bg);
    color: #fff;
    border: none;
    border-radius: var(--border-radius);
    font-size: 1.25rem;
    font-weight: 700;
    cursor: pointer;
    transition: background-color 0.25s ease;
    box-shadow: 0 4px 8px rgba(90, 74, 61, 0.3);
    font-family: inherit
}

.submit-btn:hover {
    background: var(--button-hover-bg);
}

@media (max-width: 768px) {
    .cake-builder {
        flex-direction: column;
    }

    .cake-visual {
        order: -1;
        margin-bottom: 30px;
    }
}

/* Анимации */
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.cake-preview.updated {
    animation: pulse 0.5s ease;
}

.form-section {
    margin: 20px 0;
}

.form-section label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
}

.form-section select,
.form-section textarea,
.form-section input[type="file"] {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--input-border);
    border-radius: var(--border-radius);
    background: var(--input-bg);
    font-family: inherit;
}

.form-section textarea {
    resize: vertical;
}

/* Добавьте эти стили в ваш CSS */
#selected-flavors {
    display: flex;
    justify-content: center; /* Выравнивание по центру */
    align-items: center;
    gap: 10px; /* Отступы между иконками */
    margin-top: 15px;
}

#selected-flavors img {
    width: 40px;
    height: 40px;
    object-fit: contain;
    display: block; /* Чтобы убрать возможные пробелы под изображением */
}
input[type="file"]::-webkit-file-upload-button {
    background-color: #cbbca7; /* темно-бежевый */
    color: white;
    border: none;
    border-radius: var(--border-radius);
    padding: 6px 12px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.25s ease;
    font-family: inherit;
}

input[type="file"]::-webkit-file-upload-button:hover {
    background-color: #b3a68f; /* чуть темнее при наведении */
}

</style>

<div class="custom-cake-container">
    <h1 class="custom-cake-title">Конструктор торта</h1>

    <div class="cake-builder">
        <div class="cake-visual">
            <div class="cake-preview-container">
                <div class="cake-preview" id="cake-preview">
                    <div class="cake-outside" id="cake-outside"></div>
                    <div class="cake-inside">
                        <div class="cake-biscuit-top" id="biscuit-top-visual"></div>
                        <div class="cake-cream" id="cream-visual">
                            <div class="cake-filling" id="filling-visual"></div>
                        </div>
                        <div class="cake-biscuit-bottom" id="biscuit-bottom-visual"></div>
                    </div>
                </div>

                <div class="cake-decoration-container" id="selected-flavors">
                    <!-- Здесь будут отображаться иконки выбранных вкусов -->
                </div>

                <div class="cake-description" id="cake-description"
                     style="margin-top: 20px; text-align: center; font-weight: 600;"></div>
            </div>
        </div>

        <div class="cake-options">
            <div class="option-tabs">
                <div class="option-tab active" data-tab="biscuit">Бисквит</div>
                <div class="option-tab" data-tab="cream">Крем</div>
                <div class="option-tab" data-tab="filling">Начинка</div>
                <div class="option-tab" data-tab="decoration">Оформление</div>
            </div>

            <form method="post" enctype="multipart/form-data" id="cake-form"
                  action="{% url 'custom_cake:build_cake' %}">
                {% csrf_token %}

                <!-- Бисквит -->
                <div class="option-content active" id="biscuit-content">
                    <div class="option-grid">
                        <div class="option-item" data-value="vanilla" data-name="Ванильный" data-color="#f5e6c8"
                             data-icon="biscuit-vanilla.png">
                            <img src="{% static 'shop/images_cake/biscuit-vanilla.png' %}" alt="Ванильный">
                            <div class="option-name">Ванильный</div>
                        </div>
                        <div class="option-item" data-value="chocolate" data-name="Шоколадный" data-color="#d4a574"
                             data-icon="biscuit-chocolate.png">
                            <img src="{% static 'shop/images_cake/biscuit-chocolate.png' %}" alt="Шоколадный">
                            <div class="option-name">Шоколадный</div>
                        </div>
                        <div class="option-item" data-value="carrot" data-name="Морковный" data-color="#e6b574"
                             data-icon="biscuit-carrot.png">
                            <img src="{% static 'shop/images_cake/biscuit-carrot.png' %}" alt="Морковный">
                            <div class="option-name">Морковный</div>
                        </div>
                        <div class="option-item" data-value="nut" data-name="Ореховый" data-color="#c9a87e"
                             data-icon="biscuit-nut.png">
                            <img src="{% static 'shop/images_cake/biscuit-nut.png' %}" alt="Ореховый">
                            <div class="option-name">Ореховый</div>
                        </div>
                        <div class="option-item" data-value="other" data-name="Другой" data-color="#e8c988"
                             data-icon="biscuit-other.png">
                            <img src="{% static 'shop/images_cake/others.png' %}" alt="Другой">
                            <div class="option-name">Другой</div>
                        </div>
                    </div>
                    <input type="hidden" name="biscuit" id="id_biscuit" required>
                    <div class="custom-input" id="biscuit-custom-container">
                        <input type="text" name="biscuit_custom" id="id_biscuit_custom"
                               placeholder="Укажите ваш вариант бисквита">
                    </div>
                </div>

                <!-- Крем -->
                <div class="option-content" id="cream-content">
                    <div class="option-grid">
                        <div class="option-item" data-value="butter" data-name="Масляный" data-color="#f5e6c8"
                             data-icon="cream-butter.png">
                            <img src="{% static 'shop/images_cake/cream-butter.png' %}" alt="Масляный">
                            <div class="option-name">Масляный</div>
                        </div>
                        <div class="option-item" data-value="cheese" data-name="Сырный" data-color="#f0e0b6"
                             data-icon="cream-cheese.png">
                            <img src="{% static 'shop/images_cake/cream-cheese.png' %}" alt="Сырный">
                            <div class="option-name">Сырный</div>
                        </div>
                        <div class="option-item" data-value="whipped" data-name="Взбитый" data-color="#f5f0e6"
                             data-icon="cream-whipped.png">
                            <img src="{% static 'shop/images_cake/cream-whipped.png' %}" alt="Взбитый">
                            <div class="option-name">Взбитый</div>
                        </div>
                        <div class="option-item" data-value="chocolate" data-name="Шоколадный" data-color="#d4b574"
                             data-icon="cream-chocolate.png">
                            <img src="{% static 'shop/images_cake/biscuit-chocolate.png' %}" alt="Шоколадный">
                            <div class="option-name">Шоколадный</div>
                        </div>
                        <div class="option-item" data-value="other" data-name="Другой" data-color="#f5e6c8"
                             data-icon="cream-other.png">
                            <img src="{% static 'shop/images_cake/others.png' %}" alt="Другой">
                            <div class="option-name">Другой</div>
                        </div>
                    </div>
                    <input type="hidden" name="cream" id="id_cream" required>
                    <div class="custom-input" id="cream-custom-container">
                        <input type="text" name="cream_custom" id="id_cream_custom"
                               placeholder="Укажите ваш вариант крема">
                    </div>
                </div>

                <!-- Начинка -->
                <div class="option-content" id="filling-content">
                    <div class="option-grid">
                        <div class="option-item" data-value="strawberry" data-name="Клубника" data-color="#ff6b6b"
                             data-icon="filling-strawberry.png">
                            <img src="{% static 'shop/images_cake/filling-strawberry.png' %}" alt="Клубника">
                            <div class="option-name">Клубника</div>
                        </div>
                        <div class="option-item" data-value="cherry" data-name="Вишня" data-color="#c94e4e"
                             data-icon="filling-cherry.png">
                            <img src="{% static 'shop/images_cake/filling-cherry.png' %}" alt="Вишня">
                            <div class="option-name">Вишня</div>
                        </div>
                        <div class="option-item" data-value="lemon" data-name="Лимон" data-color="#f5e6a1"
                             data-icon="filling-lemon.png">
                            <img src="{% static 'shop/images_cake/filling-lemon.png' %}" alt="Лимон">
                            <div class="option-name">Лимон</div>
                        </div>
                        <div class="option-item" data-value="caramel" data-name="Карамель" data-color="#d4a574"
                             data-icon="filling-caramel.png">
                            <img src="{% static 'shop/images_cake/filling-caramel.png' %}" alt="Карамель">
                            <div class="option-name">Карамель</div>
                        </div>
                        <div class="option-item" data-value="other" data-name="Другая" data-color="#e6b574"
                             data-icon="filling-other.png">
                            <img src="{% static 'shop/images_cake/others.png' %}" alt="Другая">
                            <div class="option-name">Другая</div>
                        </div>
                    </div>
                    <input type="hidden" name="filling" id="id_filling" required>
                    <div class="custom-input" id="filling-custom-container">
                        <input type="text" name="filling_custom" id="id_filling_custom"
                               placeholder="Укажите ваш вариант начинки">
                    </div>
                </div>

                <!-- Оформление -->
                <div class="option-content" id="decoration-content">
                    <div class="option-grid">
                        <div class="option-item" data-value="cream" data-name="Крем" data-icon="decor-cream.png">
                            <img src="{% static 'shop/images_cake/cream-whipped.png' %}" alt="Крем">
                            <div class="option-name">Крем</div>
                        </div>
                        <div class="option-item" data-value="sprinkles" data-name="Посыпка"
                             data-icon="decor-sprinkles.png">
                            <img src="{% static 'shop/images_cake/decor-sprinkles.png' %}" alt="Посыпка">
                            <div class="option-name">Посыпка</div>
                        </div>
                        <div class="option-item" data-value="fruit" data-name="Фрукты" data-icon="decor-fruit.png">
                            <img src="{% static 'shop/images_cake/decor-fruit.png' %}" alt="Фрукты">
                            <div class="option-name">Фрукты</div>
                        </div>
                        <div class="option-item" data-value="nuts" data-name="Орехи" data-icon="decor-nuts.png">
                            <img src="{% static 'shop/images_cake/biscuit-nut.png' %}" alt="Орехи">
                            <div class="option-name">Орехи</div>
                        </div>
                        <div class="option-item" data-value="other" data-name="Другое" data-icon="decor-other.png">
                            <img src="{% static 'shop/images_cake/others.png' %}" alt="Другое">
                            <div class="option-name">Другое</div>
                        </div>
                    </div>
                    <input type="hidden" name="decoration" id="id_decoration">
                    <div class="custom-input" id="decoration-custom-container">
                        <input type="text" name="decoration_custom" id="id_decoration_custom"
                               placeholder="Укажите ваш вариант оформления">
                    </div>
                </div>

                <!-- Дополнительные параметры -->
                <div class="form-section">
                    <label for="id_weight">Вес торта (кг)</label>
                    <select name="weight" id="id_weight" required>
                        <option value="" disabled selected>Выберите вес</option>
                        <option value="1">1 кг</option>
                        <option value="1.5">1.5 кг</option>
                        <option value="2">2 кг</option>
                        <option value="3">3 кг</option>
                        <option value="5">5 кг</option>
                    </select>
                </div>

                <div class="form-section">
                    <label for="id_photo_example">Фото для примера (необязательно)</label>
                    <input type="file" name="photo_example" id="id_photo_example" accept="image/*">
                </div>

                <div class="form-section">
                    <label for="id_comment">Пожелания (необязательно)</label>
                    <textarea name="comment" id="id_comment" rows="3"
                              placeholder="Например: 'Хочу розовый торт с золотыми акцентами'"></textarea>
                </div>

                <div class="price-block">
                    Сумма заказа: <span id="cake-price">1000</span> ₽
                </div>

                <button type="submit" class="submit-btn">Добавить в корзину</button>
            </form>
        </div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Получаем префикс статических файлов из шаблона
    const STATIC_URL = "{% static '' %}";

    // Переключение вкладок
    const tabs = document.querySelectorAll('.option-tab');
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            tabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');

            const tabId = this.getAttribute('data-tab');
            document.querySelectorAll('.option-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabId}-content`).classList.add('active');
        });
    });

    // Выбор опций
    const optionItems = document.querySelectorAll('.option-item');
    const cakePreview = document.getElementById('cake-preview');
    const cakeDescription = document.getElementById('cake-description');
    const selectedFlavorsContainer = document.getElementById('selected-flavors');
    let selectedDecorations = [];
    let selectedFlavors = {};

    // Словарь для названий оформления
    const decorationNames = {
        'cream': 'Крем',
        'sprinkles': 'Посыпка',
        'fruit': 'Фрукты',
        'nuts': 'Орехи',
        'other': 'Другое'
    };

    optionItems.forEach(item => {
        item.addEventListener('click', function() {
            const tab = this.closest('.option-content').id.replace('-content', '');
            const value = this.getAttribute('data-value');
            const name = this.getAttribute('data-name');
            const color = this.getAttribute('data-color');
            const icon = this.getAttribute('data-icon');

            // Сброс предыдущего выбора в этой вкладке (кроме оформления)
            if (tab !== 'decoration') {
                document.querySelectorAll(`#${tab}-content .option-item`).forEach(i => {
                    i.classList.remove('selected');
                });
                this.classList.add('selected');
            }

            // Установка значения в скрытое поле
            if (tab !== 'decoration') {
                document.getElementById(`id_${tab}`).value = value;
            }

            // Обработка поля "Другое"
            const customContainer = document.getElementById(`${tab}-custom-container`);
            if (value === 'other') {
                customContainer.style.display = 'block';
                document.getElementById(`id_${tab}_custom`).required = true;
            } else {
                customContainer.style.display = 'none';
                document.getElementById(`id_${tab}_custom`).required = false;
                document.getElementById(`id_${tab}_custom`).value = '';

                // Обновление визуализации
                updateCakeVisual(tab, value, name, color);

                // Сохраняем выбранный вкус для отображения иконки
                if (tab !== 'decoration') {
                    selectedFlavors[tab] = {name, icon};
                    updateSelectedFlavors();
                }
            }

            // Особый случай для оформления (можно выбирать несколько)
            if (tab === 'decoration') {
                if (value === 'other') return;

                const index = selectedDecorations.indexOf(value);
                if (index === -1) {
                    selectedDecorations.push(value);
                    this.classList.add('selected');
                } else {
                    selectedDecorations.splice(index, 1);
                    this.classList.remove('selected');
                }

                document.getElementById('id_decoration').value = selectedDecorations.join(',');
                updateDecorationsVisual();
            }

            calculatePrice();
            cakePreview.classList.add('updated');
            setTimeout(() => cakePreview.classList.remove('updated'), 500);
        });
    });

    function updateCakeVisual(part, value, name, color) {
        if (part === 'biscuit') {
            document.getElementById('biscuit-top-visual').style.backgroundColor = color;
            document.getElementById('biscuit-bottom-visual').style.backgroundColor = color;
        } else if (part === 'cream') {
            document.getElementById('cream-visual').style.backgroundColor = color;
        } else if (part === 'filling') {
            document.getElementById('filling-visual').style.backgroundColor = color;
        }

        updateCakeDescription();
    }

    function updateSelectedFlavors() {
        selectedFlavorsContainer.innerHTML = '';

        for (const [part, flavor] of Object.entries(selectedFlavors)) {
            if (!flavor.icon) continue;

            const flavorItem = document.createElement('div');
            flavorItem.className = 'cake-decoration-item';
            flavorItem.title = `${part}: ${flavor.name}`;

            const img = document.createElement('img');
            img.alt = flavor.name;
            img.src = STATIC_URL + 'shop/images_cake/' + flavor.icon;

            flavorItem.appendChild(img);
            selectedFlavorsContainer.appendChild(flavorItem);
        }
    }

    function updateDecorationsVisual() {
        // Для оформления мы просто сохраняем выбранные варианты
        // Фактическое оформление будет применяться при производстве
        updateCakeDescription();
    }

    function updateCakeDescription() {
        const biscuit = document.querySelector('#biscuit-content .option-item.selected')?.getAttribute('data-name') || 'не выбран';
        const cream = document.querySelector('#cream-content .option-item.selected')?.getAttribute('data-name') || 'не выбран';
        const filling = document.querySelector('#filling-content .option-item.selected')?.getAttribute('data-name') || 'не выбран';
        const decorations = selectedDecorations.length > 0 ?
            selectedDecorations.map(d => decorationNames[d] || d).join(', ') : 'не выбрано';

        cakeDescription.textContent = `Ваш торт: ${biscuit} бисквит, ${cream} крем, ${filling} начинка, оформление: ${decorations}`;
    }

    // Расчет цены
    function calculatePrice() {
        const basePricePerKg = 1000;
        const weight = parseFloat(document.getElementById('id_weight').value) || 1;
        let price = basePricePerKg * weight;
        document.getElementById('cake-price').textContent = price.toFixed(2);
    }

    // Слушаем изменения веса для пересчета цены
    document.getElementById('id_weight').addEventListener('change', calculatePrice);

    // Инициализация цены
    calculatePrice();
});
</script>
{% endblock %}