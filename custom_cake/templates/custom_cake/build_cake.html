{% extends 'base.html' %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'custom_cake/css/build_cake.css' %}">

<div class="custom-cake-container">
    <h1 class="custom-cake-title">Конструктор торта</h1>

    <div class="cake-builder">
        <div class="cake-visual">
            <div class="cake-preview-container">
                <div class="cake-preview" id="cake-preview">
                    <div class="cake-outside" id="cake-outside"></div>
                    <div class="cake-inside">
                        <div class="cake-biscuit-top" id="biscuit-top-visual"></div>
                        <div class="cake-cream" id="cream-visual">
                            <div class="cake-filling" id="filling-visual"></div>
                        </div>
                        <div class="cake-biscuit-bottom" id="biscuit-bottom-visual"></div>
                    </div>
                </div>
                <div class="cake-decoration-container" id="selected-flavors"></div>
                <div class="cake-description" id="cake-description"
                     style="margin-top: 20px; text-align: center; font-weight: 600;"></div>
            </div>
        </div>

        <div class="cake-options">
            <div class="option-tabs">
                <div class="option-tab active" data-tab="biscuit">Бисквит</div>
                <div class="option-tab" data-tab="cream">Крем</div>
                <div class="option-tab" data-tab="filling">Начинка</div>
                <div class="option-tab" data-tab="decoration">Оформление</div>
            </div>

            <form method="post" enctype="multipart/form-data" id="cake-form"
                  action="{% url 'custom_cake:build_cake' %}">
                {% csrf_token %}

                <div class="option-content active" id="biscuit-content">
                    <div class="option-grid">
                        <div class="option-item" data-value="vanilla" data-name="Ванильный" data-color="#f5e6c8"
                             data-icon="biscuit-vanilla.png">
                            <img src="{% static 'shop/images_cake/biscuit-vanilla.png' %}" alt="Ванильный">
                            <div class="option-name">Ванильный</div>
                        </div>
                        <div class="option-item" data-value="chocolate" data-name="Шоколадный" data-color="#d4a574"
                             data-icon="biscuit-chocolate.png">
                            <img src="{% static 'shop/images_cake/biscuit-chocolate.png' %}" alt="Шоколадный">
                            <div class="option-name">Шоколадный</div>
                        </div>
                        <div class="option-item" data-value="carrot" data-name="Морковный" data-color="#e6b574"
                             data-icon="biscuit-carrot.png">
                            <img src="{% static 'shop/images_cake/biscuit-carrot.png' %}" alt="Морковный">
                            <div class="option-name">Морковный</div>
                        </div>
                        <div class="option-item" data-value="nut" data-name="Ореховый" data-color="#c9a87e"
                             data-icon="biscuit-nut.png">
                            <img src="{% static 'shop/images_cake/biscuit-nut.png' %}" alt="Ореховый">
                            <div class="option-name">Ореховый</div>
                        </div>
                        <div class="option-item" data-value="other" data-name="Другой" data-color="#e8c988"
                             data-icon="biscuit-other.png">
                            <img src="{% static 'shop/images_cake/others.png' %}" alt="Другой">
                            <div class="option-name">Другой</div>
                        </div>
                    </div>
                    <input type="hidden" name="biscuit" id="id_biscuit" required>
                    <div class="custom-input" id="biscuit-custom-container">
                        <input type="text" name="biscuit_custom" id="id_biscuit_custom"
                               placeholder="Укажите ваш вариант бисквита">
                    </div>
                </div>

                <div class="option-content" id="cream-content">
                    <div class="option-grid">
                        <div class="option-item" data-value="butter" data-name="Масляный" data-color="#f5e6c8"
                             data-icon="cream-butter.png">
                            <img src="{% static 'shop/images_cake/cream-butter.png' %}" alt="Масляный">
                            <div class="option-name">Масляный</div>
                        </div>
                        <div class="option-item" data-value="cheese" data-name="Сырный" data-color="#f0e0b6"
                             data-icon="cream-cheese.png">
                            <img src="{% static 'shop/images_cake/cream-cheese.png' %}" alt="Сырный">
                            <div class="option-name">Сырный</div>
                        </div>
                        <div class="option-item" data-value="whipped" data-name="Взбитый" data-color="#f5f0e6"
                             data-icon="cream-whipped.png">
                            <img src="{% static 'shop/images_cake/cream-whipped.png' %}" alt="Взбитый">
                            <div class="option-name">Взбитый</div>
                        </div>
                        <div class="option-item" data-value="chocolate" data-name="Шоколадный" data-color="#d4b574"
                             data-icon="cream-chocolate.png">
                            <img src="{% static 'shop/images_cake/cream-chocolate.png' %}" alt="Шоколадный">
                            <div class="option-name">Шоколадный</div>
                        </div>
                        <div class="option-item" data-value="other" data-name="Другой" data-color="#f5e6c8"
                             data-icon="cream-other.png">
                            <img src="{% static 'shop/images_cake/others.png' %}" alt="Другой">
                            <div class="option-name">Другой</div>
                        </div>
                    </div>
                    <input type="hidden" name="cream" id="id_cream" required>
                    <div class="custom-input" id="cream-custom-container">
                        <input type="text" name="cream_custom" id="id_cream_custom"
                               placeholder="Укажите ваш вариант крема">
                    </div>
                </div>

                <div class="option-content" id="filling-content">
                    <div class="option-grid">
                        <div class="option-item" data-value="strawberry" data-name="Клубника" data-color="#ff6b6b"
                             data-icon="filling-strawberry.png">
                            <img src="{% static 'shop/images_cake/filling-strawberry.png' %}" alt="Клубника">
                            <div class="option-name">Клубника</div>
                        </div>
                        <div class="option-item" data-value="cherry" data-name="Вишня" data-color="#c94e4e"
                             data-icon="filling-cherry.png">
                            <img src="{% static 'shop/images_cake/filling-cherry.png' %}" alt="Вишня">
                            <div class="option-name">Вишня</div>
                        </div>
                        <div class="option-item" data-value="lemon" data-name="Лимон" data-color="#f5e6a1"
                             data-icon="filling-lemon.png">
                            <img src="{% static 'shop/images_cake/filling-lemon.png' %}" alt="Лимон">
                            <div class="option-name">Лимон</div>
                        </div>
                        <div class="option-item" data-value="caramel" data-name="Карамель" data-color="#d4a574"
                             data-icon="filling-caramel.png">
                            <img src="{% static 'shop/images_cake/filling-caramel.png' %}" alt="Карамель">
                            <div class="option-name">Карамель</div>
                        </div>
                        <div class="option-item" data-value="other" data-name="Другая" data-color="#e6b574"
                             data-icon="filling-other.png">
                            <img src="{% static 'shop/images_cake/others.png' %}" alt="Другая">
                            <div class="option-name">Другая</div>
                        </div>
                    </div>
                    <input type="hidden" name="filling" id="id_filling" required>
                    <div class="custom-input" id="filling-custom-container">
                        <input type="text" name="filling_custom" id="id_filling_custom"
                               placeholder="Укажите ваш вариант начинки">
                    </div>
                </div>

                <div class="option-content" id="decoration-content">
                    <div class="option-grid">
                        <div class="option-item" data-value="cream" data-name="Крем" data-icon="decor-cream.png">
                            <img src="{% static 'shop/images_cake/cream-whipped.png' %}" alt="Крем">
                            <div class="option-name">Крем</div>
                        </div>
                        <div class="option-item" data-value="sprinkles" data-name="Посыпка"
                             data-icon="decor-sprinkles.png">
                            <img src="{% static 'shop/images_cake/decor-sprinkles.png' %}" alt="Посыпка">
                            <div class="option-name">Посыпка</div>
                        </div>
                        <div class="option-item" data-value="fruit" data-name="Фрукты" data-icon="decor-fruit.png">
                            <img src="{% static 'shop/images_cake/decor-fruit.png' %}" alt="Фрукты">
                            <div class="option-name">Фрукты</div>
                        </div>
                        <div class="option-item" data-value="nuts" data-name="Орехи" data-icon="decor-nuts.png">
                            <img src="{% static 'shop/images_cake/biscuit-nut.png' %}" alt="Орехи">
                            <div class="option-name">Орехи</div>
                        </div>
                        <div class="option-item" data-value="other" data-name="Другое" data-icon="decor-other.png">
                            <img src="{% static 'shop/images_cake/others.png' %}" alt="Другое">
                            <div class="option-name">Другое</div>
                        </div>
                    </div>
                    <input type="hidden" name="decoration" id="id_decoration">
                    <div class="custom-input" id="decoration-custom-container">
                        <input type="text" name="decoration_custom" id="id_decoration_custom"
                               placeholder="Укажите ваш вариант оформления">
                    </div>
                </div>

                <div class="form-section">
                    <label for="id_weight">Вес торта (кг)</label>
                    <select name="weight" id="id_weight" required>
                        <option value="" disabled selected>Выберите вес</option>
                        <option value="1">1 кг</option>
                        <option value="1.5">1.5 кг</option>
                        <option value="2">2 кг</option>
                        <option value="3">3 кг</option>
                        <option value="5">5 кг</option>
                    </select>
                </div>

                <div class="form-section">
                    <label for="id_photo_example">Фото для примера (необязательно)</label>
                    <input type="file" name="photo_example" id="id_photo_example" accept="image/*">
                </div>

                <div class="form-section">
                    <label for="id_comment">Пожелания (необязательно)</label>
                    <textarea name="comment" id="id_comment" rows="3"
                              placeholder="Например: 'Хочу розовый торт с золотыми акцентами'"></textarea>
                </div>

                <div class="price-block">
                    Сумма заказа: <span id="cake-price">1000</span> ₽
                </div>

                <button type="submit" class="submit-btn">Добавить в корзину</button>
            </form>
        </div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const STATIC_URL = "{% static '' %}";
    const tabs = document.querySelectorAll('.option-tab');
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            tabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');

            const tabId = this.getAttribute('data-tab');
            document.querySelectorAll('.option-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabId}-content`).classList.add('active');
        });
    });
    const optionItems = document.querySelectorAll('.option-item');
    const cakePreview = document.getElementById('cake-preview');
    const cakeDescription = document.getElementById('cake-description');
    const selectedFlavorsContainer = document.getElementById('selected-flavors');
    let selectedDecorations = [];
    let selectedFlavors = {};
    const decorationNames = {
        'cream': 'Крем',
        'sprinkles': 'Посыпка',
        'fruit': 'Фрукты',
        'nuts': 'Орехи',
        'other': 'Другое'
    };
    optionItems.forEach(item => {
        item.addEventListener('click', function() {
            const tab = this.closest('.option-content').id.replace('-content', '');
            const value = this.getAttribute('data-value');
            const name = this.getAttribute('data-name');
            const color = this.getAttribute('data-color');
            const icon = this.getAttribute('data-icon');

            if (tab !== 'decoration') {
                document.querySelectorAll(`#${tab}-content .option-item`).forEach(i => {
                    i.classList.remove('selected');
                });
                this.classList.add('selected');
            }
            if (tab !== 'decoration') {
                document.getElementById(`id_${tab}`).value = value;
            }
            const customContainer = document.getElementById(`${tab}-custom-container`);
            if (value === 'other') {
                customContainer.style.display = 'block';
                document.getElementById(`id_${tab}_custom`).required = true;
            } else {
                customContainer.style.display = 'none';
                document.getElementById(`id_${tab}_custom`).required = false;
                document.getElementById(`id_${tab}_custom`).value = '';

                updateCakeVisual(tab, value, name, color);
                if (tab !== 'decoration') {
                    selectedFlavors[tab] = {name, icon};
                    updateSelectedFlavors();
                }
            }

            if (tab === 'decoration') {
                if (value === 'other') return;

                const index = selectedDecorations.indexOf(value);
                if (index === -1) {
                    selectedDecorations.push(value);
                    this.classList.add('selected');
                } else {
                    selectedDecorations.splice(index, 1);
                    this.classList.remove('selected');
                }

                document.getElementById('id_decoration').value = selectedDecorations.join(',');
                updateDecorationsVisual();
            }

            calculatePrice();
            cakePreview.classList.add('updated');
            setTimeout(() => cakePreview.classList.remove('updated'), 500);
        });
    });

    function updateCakeVisual(part, value, name, color) {
        if (part === 'biscuit') {
            document.getElementById('biscuit-top-visual').style.backgroundColor = color;
            document.getElementById('biscuit-bottom-visual').style.backgroundColor = color;
        } else if (part === 'cream') {
            document.getElementById('cream-visual').style.backgroundColor = color;
        } else if (part === 'filling') {
            document.getElementById('filling-visual').style.backgroundColor = color;
        }

        updateCakeDescription();
    }

    function updateSelectedFlavors() {
        selectedFlavorsContainer.innerHTML = '';

        for (const [part, flavor] of Object.entries(selectedFlavors)) {
            if (!flavor.icon) continue;

            const flavorItem = document.createElement('div');
            flavorItem.className = 'cake-decoration-item';
            flavorItem.title = `${part}: ${flavor.name}`;

            const img = document.createElement('img');
            img.alt = flavor.name;
            img.src = STATIC_URL + 'shop/images_cake/' + flavor.icon;

            flavorItem.appendChild(img);
            selectedFlavorsContainer.appendChild(flavorItem);
        }
    }

    function updateDecorationsVisual() {
        updateCakeDescription();
    }

    function updateCakeDescription() {
        const biscuit = document.querySelector('#biscuit-content .option-item.selected')?.getAttribute('data-name') || 'не выбран';
        const cream = document.querySelector('#cream-content .option-item.selected')?.getAttribute('data-name') || 'не выбран';
        const filling = document.querySelector('#filling-content .option-item.selected')?.getAttribute('data-name') || 'не выбран';
        const decorations = selectedDecorations.length > 0 ?
            selectedDecorations.map(d => decorationNames[d] || d).join(', ') : 'не выбрано';

        cakeDescription.textContent = `Ваш торт: ${biscuit} бисквит, ${cream} крем, ${filling} начинка, оформление: ${decorations}`;
    }

    function calculatePrice() {
        const basePricePerKg = 1000;
        const weight = parseFloat(document.getElementById('id_weight').value) || 1;
        let price = basePricePerKg * weight;
        document.getElementById('cake-price').textContent = price.toFixed(2);
    }
    document.getElementById('id_weight').addEventListener('change', calculatePrice);
    calculatePrice();
});
</script>
{% endblock %}