{% extends 'base.html' %}
{% load static %}
{% block title %}Профиль пользователя{% endblock %}
{% block content %}
<link rel="stylesheet" href="{% static 'shop/css/profile.css' %}">

<div class="profile-content">
    <div class="profile-photo-section">
        {% if profile.image %}
            <img src="{{ profile.image.url }}" alt="Фото пользователя" class="profile-photo" id="profile-photo-preview-img">
        {% else %}
            <div class="no-photo" id="profile-photo-preview-div">Фото профиля</div>
        {% endif %}

        {% if edit_mode %}
            <input type="file" name="image" id="id_image" style="display:none;" accept="image/*" form="profile-form">

            <button type="button" class="change-photo-btn" id="change-photo-btn">Изменить фото</button>
        {% endif %}
    </div>

    <div class="profile-info">
        {% if edit_mode %}
            <form method="post" enctype="multipart/form-data" id="profile-form">
                {% csrf_token %}

                <div class="info-block">
                    <h3>Основная информация</h3>

                    <div class="info-row">
                        <label for="{{ form.last_name.id_for_label }}" class="info-label">Фамилия</label>
                        {{ form.last_name }}
                    </div>

                    <div class="info-row">
                        <label for="{{ form.first_name.id_for_label }}" class="info-label">Имя</label>
                        {{ form.first_name }}
                    </div>

                    <div class="info-row">
                        <label for="{{ form.patronymic.id_for_label }}" class="info-label">Отчество</label>
                        {{ form.patronymic }}
                    </div>

                    <div class="info-row">
                        <label for="{{ form.birth_date.id_for_label }}" class="info-label">Дата рождения</label>
                        {{ form.birth_date }}
                    </div>

                    <div class="info-row">
                        <label for="{{ form.gender.id_for_label }}" class="info-label">Пол</label>
                        {{ form.gender }}
                    </div>

                    <div class="info-row">
                        <label for="{{ form.city.id_for_label }}" class="info-label">Город</label>
                        {{ form.city }}
                    </div>
                </div>
                <div class="info-row">
                    <label for="{{ form.email.id_for_label }}" class="info-label">Электронная почта</label>
                    {{ form.email }}
                </div>

                <button type="submit" class="save-btn">Сохранить изменения</button>
            </form>
        {% else %}
            <div class="info-block">
                <h3>Основная информация</h3>

                <div class="info-row">
                    <div class="info-label">Фамилия:</div>
                    <div class="info-value">{{ profile.last_name }}</div>
                </div>

                <div class="info-row">
                    <div class="info-label">Имя:</div>
                    <div class="info-value">{{ profile.first_name }}</div>
                </div>

                <div class="info-row">
                    <div class="info-label">Отчество:</div>
                    <div class="info-value">{{ profile.patronymic }}</div>
                </div>

                <div class="info-row">
                    <div class="info-label">Дата рождения:</div>
                    <div class="info-value">{{ profile.birth_date|date:"d.m.Y" }}</div>
                </div>

                <div class="info-row">
                    <div class="info-label">Пол:</div>
                    <div class="info-value">
                        {% if profile.gender == "M" %}Мужской{% elif profile.gender == "F" %}Женский{% else %}-{% endif %}
                    </div>
                </div>

                <div class="info-row">
                    <div class="info-label">Город:</div>
                    <div class="info-value">{{ profile.city }}</div>
                </div>
            </div>

            <div class="info-block">
                <h3>Контактные данные</h3>

                <div class="info-row">
                    <div class="info-label">Электронная почта:</div>
                    <div class="info-value">{{ user.email }}</div>
                </div>

                <a href="?edit=1">
                    <button class="edit-btn">Изменить профиль</button>
                </a>
            </div>
        {% endif %}
    </div>
</div>

<script>
  document.getElementById('change-photo-btn')?.addEventListener('click', function() {
    document.getElementById('id_image').click();
  });
  document.getElementById('id_image')?.addEventListener('change', function(e) {
    if (e.target.files && e.target.files[0]) {
      const reader = new FileReader();
      reader.onload = function(event) {
        // Попытка найти элемент img для превью
        const img = document.getElementById('profile-photo-preview-img');
        const div = document.getElementById('profile-photo-preview-div');

        if (img) {
          img.src = event.target.result;
        } else if (div) {
          // Если img нет, заменяем div на img
          const newImg = document.createElement('img');
          newImg.id = 'profile-photo-preview-img';
          newImg.className = 'profile-photo';
          newImg.src = event.target.result;
          newImg.alt = 'Фото пользователя';

          div.replaceWith(newImg);
        }
      };
      reader.readAsDataURL(e.target.files[0]);
    }
  });
</script>
{% endblock %}
